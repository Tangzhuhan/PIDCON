# PID Temperature Control System Development Log

## 系统概述
这是一个基于PID控制的温度控制系统，具有实时数据采集、显示和控制功能。系统支持多通道温度传感器，并提供了直观的用户界面。

## 主要功能

### 1. 数据采集与显示
- 实时采集电压、电流和温度数据
- 支持多通道温度传感器（最多60个通道）
- 动态显示温度-时间曲线
- 实时显示电压和电流变化曲线
- 图表支持缩放和平移操作

### 2. 用户界面
- 左侧面板：传感器选择
  - 多选列表显示所有可用传感器
  - 实时显示选中传感器的温度数据
- 中间面板：实时数据图表
  - 电压-时间曲线
  - 电流-时间曲线
  - 温度-时间曲线（支持多通道显示）
- 右侧面板：控制参数设置
  - PID参数设置（Kp, Ki, Kd）
  - 采样速率设置
  - 初始电压设置
  - 目标温度设置
  - 持续时间设置
  - 温度误差范围设置

### 3. 控制功能
- 启动/暂停/停止控制
- 实时PID控制算法
- 自动温度调节
- 支持设置控制持续时间
- 支持设置温度误差范围

### 4. 数据记录与导出
- 实时记录所有传感器数据
- 支持按时间范围导出数据
- 导出格式为CSV文件
- 包含系统时间、相对时间、电压、电流和温度数据
- 支持选择保存目录

### 5. 图表交互功能
- 双击图表可放大显示
- 放大窗口支持缩放和平移
- 支持图例显示
- 动态调整坐标轴范围
- 多通道温度曲线使用不同颜色区分

### 6. 材料参数管理
- 支持保存不同材料的加热参数
  - 材料名称
  - 初始电压
  - PID参数（Kp, Ki, Kd）
- 支持加载已保存的参数
- 参数保存在系统标准配置目录
  - Windows: `C:\Users\<username>\AppData\Local\Personal\PIDTempControl\`
  - macOS: `/Users/<username>/Library/Application Support/PIDTempControl/`
  - Linux: `/home/<username>/.local/share/PIDTempControl/`
- 使用JSON格式存储参数，便于阅读和编辑

## 技术实现

### 1. 主要模块
- `main.py`: 主程序，包含GUI界面和控制逻辑
- `center_control.py`: PID控制器实现
- `MOD_700.py`: 温度传感器通信模块
- `power.py`: 电源控制模块

### 2. 数据存储结构
- 使用 `deque` 实现循环缓冲区
- 支持动态添加和删除数据
- 按时间戳记录数据
- 支持多通道温度数据存储
- 使用JSON文件存储材料参数

### 3. 用户界面实现
- 使用 PyQt5 构建GUI
- 使用 pyqtgraph 实现实时图表
- 支持多线程数据更新
- 实现响应式布局
- 使用 appdirs 库管理配置文件位置

## 待优化项目
1. 数据采集速率优化
2. 图表刷新性能优化
3. 多通道数据同步显示优化
4. 系统稳定性提升
5. 错误处理机制完善
6. 材料参数管理功能增强
   - 添加更多参数选项
   - 支持参数模板
   - 添加参数验证功能

## 版本历史
- v1.0: 基础功能实现
  - 多通道温度采集
  - 实时数据显示
  - PID控制功能
  - 数据导出功能
- v1.1: 功能增强
  - 添加图表放大功能
  - 优化数据记录结构
  - 改进用户界面交互
  - 添加时间范围选择导出
- v1.2: 材料参数管理
  - 添加材料参数保存功能
  - 添加材料参数加载功能
  - 使用系统标准配置目录
  - 优化参数存储结构

## 2024-03-21
### 温度传感器功能优化
1. 修复了温度曲线显示问题
   - 修改了 `update_test_plots` 方法，添加了详细的调试信息
   - 确保每个传感器都有对应的曲线，并使用不同颜色区分
   - 添加了动态X轴范围调整

2. 修复了放大窗口显示问题
   - 修改了 `EnlargedPlotWindow` 类，确保正确复制和更新图表数据
   - 添加了曲线引用管理，方便更新数据
   - 改进了图例显示和交互功能

3. 优化了测试时长设置
   - 将测试时长固定为60秒
   - 移除了测试时长输入对话框
   - 更新了相关的日志输出

4. 改进了数据保存功能
   - 在测试数据中添加了系统时间字段
   - 修改了CSV文件格式，包含系统时间和测试时间
   - 优化了传感器名称的显示格式
   - 添加了详细的调试信息输出

5. 调试信息优化
   - 在关键方法中添加了详细的调试输出
   - 添加了数据验证和错误处理
   - 优化了日志信息的可读性

### 电源发生器功能优化
1. 重写了 `power.py` 文件
   - 添加了详细的调试信息输出
   - 优化了串口通信逻辑
   - 添加了命令和响应的解析显示

2. 串口通信改进
   - 添加了串口状态检查
   - 为每个串口操作添加了异常处理
   - 添加了更详细的错误信息输出

3. 采样率优化
   - 将默认采样率从12ms调整为30ms
   - 考虑了传感器读取时间（5ms/个）
   - 为系统处理预留了足够时间

4. 系统运行逻辑优化
   - 移除了自动停止功能，改为持续运行
   - 保留测试功能的60秒固定时长
   - 优化了暂停和停止功能

### 待优化项
1. 考虑添加数据导出格式选择（CSV/Excel）
2. 考虑添加数据可视化选项（如温度变化率、统计信息等）
3. 考虑添加自动保存功能，定期保存测试数据
4. 考虑添加数据回放功能，可以查看历史测试数据
5. 考虑添加串口通信状态监控
6. 考虑添加通信错误自动重试机制